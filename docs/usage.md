# 使用说明

## 功能概述

WebSocket 客户端应用提供了完整的 WebSocket 连接管理功能，包括：

- ✅ WebSocket 连接管理
- ✅ 自动断线重连
- ✅ 心跳保活机制
- ✅ 长时间无消息自动断开
- ✅ 自定义消息格式化
- ✅ 文件传输支持
- ✅ Web 界面管理

## 主要功能

### 1. 连接配置

#### 连接地址设置

在"连接配置"面板中，可以设置 WebSocket 服务器地址：

- 格式: `ws://host:port` 或 `wss://host:port`
- 示例: `ws://localhost:8080`

#### 请求头设置

可以设置自定义请求头，用于身份验证等：

```json
{
  "Authorization": "Bearer token",
  "Custom-Header": "value"
}
```

#### 心跳间隔

设置心跳保活的间隔时间（毫秒）：

- 默认: 30000 (30秒)
- 最小值: 1000 (1秒)
- 建议: 根据服务器要求设置

#### 空闲超时

设置长时间无用户消息后自动断开的时间（毫秒）：

- 默认: 300000 (5分钟)
- 设置为 0 表示禁用此功能

### 2. 消息格式化

#### 格式类型

支持以下消息格式：

- **文本**: 纯文本消息
- **JSON**: JSON 格式消息
- **二进制**: 二进制数据
- **自定义**: 使用自定义格式化函数

#### 自定义格式化

选择"自定义"格式后，可以输入 JavaScript 函数：

```javascript
(data) => {
  return JSON.stringify({
    timestamp: Date.now(),
    data: data
  });
}
```

点击"设置格式化函数"按钮应用。

### 3. 发送消息

#### 文本消息

1. 在"消息内容"输入框中输入消息
2. 选择消息格式
3. 点击"发送消息"按钮

#### 文件消息

1. 点击"文件"选择按钮，选择要发送的文件
2. （可选）在"消息内容"中输入附加消息
3. 选择消息格式（建议使用 JSON）
4. 点击"发送消息"按钮

文件会被转换为 Base64 编码并包含在消息中。

#### 文件切片发送

支持大文件分片发送，包含两种模式：

- **大小切片**：按设定的 KB 大小切片（默认 64KB，可在“切片大小 (KB)”输入）
- **时间切片（音频/视频）**：检测到音频/视频文件时可按毫秒切片（在“切片时间 (ms)”输入，建议 1000-5000ms）
- 支持可选去掉 WAV 头（勾选“去掉 WAV 头”）
- 发送时将切片的 Base64 数据放入指定 JSON 字段（支持点号嵌套，如 `data.file`），原有 JSON 结构保持不变

操作步骤：
1. 选择文件并勾选“启用文件切片发送”
2. 若为音频/视频，可选择时间切片；否则使用大小切片
3. 配置切片大小或时间，并填写文件字段名
4. 点击“发送消息”开始分片发送

> 每个切片都会携带进度显示，时间切片还会显示起止毫秒范围。

#### 语音模式（流式发送）

支持在浏览器中录音并流式发送语音数据，分为三类可自定义 JSON 包：

- **开始包**：录制开始时发送，字段可自定义或粘贴 JSON
- **音频切片包**：录制过程中每个音频块实时发送，可单独配置字段；未配置时回退使用开始包配置
- **结束包**：点击结束后发送，可自定义或粘贴 JSON

操作步骤：
1. 勾选“启用语音模式”
2. 分别配置开始包、结束包、音频切片包字段（支持点号嵌套），或使用“粘贴 JSON”快速填充
3. 设置“音频数据字段名”（默认为 `audio`）及是否 Base64 编码
4. 录制：点击“开始语音”→ 实时流式发送音频切片 → 点击“结束语音”发送结束包

> 流式发送为异步非阻塞，能持续推送音频切片，适用于实时语音传输。

### 4. 消息显示

#### 消息列表

- 发送的消息显示为绿色
- 接收的消息显示为蓝色
- 每条消息包含时间戳

#### 显示格式

可以选择消息显示格式：

- **文本显示**: 原始文本格式
- **JSON 显示**: 格式化后的 JSON（如果是 JSON 消息）

#### 自动滚动

勾选"自动滚动"后，新消息会自动滚动到底部。

#### 清空历史

点击"清空消息历史"按钮可以清空所有消息记录。

### 5. 连接管理

#### 连接

1. 配置连接参数
2. 点击"保存配置"
3. 点击"连接"按钮

连接状态会在顶部状态指示器中显示。

#### 断开

点击"断开"按钮可以主动断开连接。

#### 状态指示

- 🟢 **已连接**: 连接正常
- 🟡 **连接中**: 正在建立连接
- 🔴 **未连接**: 未连接或已断开

## API 接口

### GET /api/status

获取连接状态和配置信息。

**响应**:
```json
{
  "success": true,
  "data": {
    "state": "OPEN",
    "config": {
      "url": "ws://localhost:8080",
      "headers": {},
      "heartbeatInterval": 30000,
      "idleTimeout": 300000
    },
    "messageCount": 10
  }
}
```

### POST /api/config

更新连接配置。

**请求体**:
```json
{
  "url": "ws://localhost:8080",
  "headers": {
    "Authorization": "Bearer token"
  },
  "heartbeatInterval": 30000,
  "idleTimeout": 300000
}
```

**响应**:
```json
{
  "success": true
}
```

### POST /api/connect

建立 WebSocket 连接。

**响应**:
```json
{
  "success": true
}
```

### POST /api/disconnect

断开 WebSocket 连接。

**响应**:
```json
{
  "success": true
}
```

### POST /api/send

发送消息。

**请求体**:
```json
{
  "data": "消息内容",
  "format": "text",
  "binary": false
}
```

**响应**:
```json
{
  "success": true
}
```

### POST /api/send-file

上传文件并发送。

**请求**: multipart/form-data

- `file`: 文件
- `format`: 消息格式（可选）
- `metadata`: 附加元数据 JSON 字符串（可选）

**响应**:
```json
{
  "success": true,
  "fileInfo": {
    "name": "example.txt",
    "size": 1024,
    "type": "text/plain"
  }
}
```

### GET /api/messages

获取消息历史。

**查询参数**:
- `limit`: 限制返回数量
- `type`: 消息类型（sent/received）
- `startTime`: 开始时间戳
- `endTime`: 结束时间戳

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "data": "消息内容",
      "isBinary": false,
      "timestamp": 1234567890,
      "type": "sent"
    }
  ]
}
```

### DELETE /api/messages

清空消息历史。

**响应**:
```json
{
  "success": true
}
```

## 使用示例

### 示例 1: 基本连接和发送

1. 设置连接地址: `ws://localhost:8080`
2. 点击"保存配置"
3. 点击"连接"
4. 输入消息: `Hello, WebSocket!`
5. 点击"发送消息"

### 示例 2: 发送 JSON 消息

1. 选择消息格式: JSON
2. 输入消息: `{"type": "greeting", "message": "Hello"}`
3. 点击"发送消息"

### 示例 3: 发送文件

1. 选择文件
2. 选择消息格式: JSON
3. 点击"发送消息"

文件会以以下格式发送：
```json
{
  "type": "file",
  "file": {
    "name": "example.txt",
    "size": 1024,
    "type": "text/plain",
    "data": "base64encodeddata..."
  }
}
```

### 示例 4: 自定义格式化

1. 选择消息格式: 自定义
2. 输入格式化函数:
```javascript
(data) => {
  return JSON.stringify({
    timestamp: new Date().toISOString(),
    payload: data,
    version: "1.0"
  });
}
```
3. 点击"设置格式化函数"
4. 输入消息并发送

## 注意事项

1. **连接地址**: 确保 WebSocket 服务器地址正确且可访问
2. **请求头**: 某些服务器可能需要特定的请求头（如认证令牌）
3. **心跳间隔**: 根据服务器要求设置，过短可能增加服务器负担
4. **空闲超时**: 设置为 0 可禁用自动断开功能
5. **文件大小**: 默认最大文件大小为 10MB，可在配置中修改
6. **消息格式**: 确保服务器支持所选的消息格式
7. **自定义格式化**: 格式化函数必须是有效的 JavaScript 函数

## 故障排除

### 连接失败

- 检查连接地址是否正确
- 检查服务器是否运行
- 检查网络连接
- 查看浏览器控制台错误信息

### 消息发送失败

- 确保 WebSocket 已连接
- 检查消息格式是否正确
- 查看服务器日志

### 文件上传失败

- 检查文件大小是否超过限制
- 检查文件是否可读
- 查看错误提示信息

### 重连失败

- 检查服务器是否可用
- 检查网络连接
- 查看重连日志
