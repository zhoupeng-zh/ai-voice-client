# 架构设计文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端界面                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  配置面板     │  │  消息发送     │  │  消息显示     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└───────────────────────┬───────────────────────────────────┘
                        │ HTTP/HTTPS
                        │ RESTful API
┌───────────────────────▼───────────────────────────────────┐
│                    Express Web Server                      │
│  ┌────────────────────────────────────────────────────┐   │
│  │              API Routes (/api/*)                    │   │
│  └────────────────────────────────────────────────────┘   │
└───────────────────────┬───────────────────────────────────┘
                        │
┌───────────────────────▼───────────────────────────────────┐
│              WebSocketController                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ ConfigManager│  │WebSocketClient│  │MessageFormatter│  │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                      │
│  │ FileHandler  │  │MessageModel  │                      │
│  └──────────────┘  └──────────────┘                      │
└───────────────────────┬───────────────────────────────────┘
                        │ WebSocket Protocol
                        │
┌───────────────────────▼───────────────────────────────────┐
│              WebSocket Server                             │
│              (外部服务器)                                  │
└───────────────────────────────────────────────────────────┘
```

## 模块说明

### 1. 前端界面层 (Frontend)

**位置**: `public/`

- **index.html**: 主页面结构
- **styles.css**: 样式定义
- **app.js**: 前端逻辑和 API 调用

**功能**:
- 连接配置管理
- 消息发送和接收显示
- 文件上传
- 实时状态显示

### 2. Web 服务器层 (Web Server)

**位置**: `src/index.js`, `src/routes/`

- **index.js**: Express 服务器入口
- **api-routes.js**: RESTful API 路由定义

**功能**:
- 提供静态文件服务
- 处理 HTTP API 请求
- 文件上传处理

### 3. 控制器层 (Controller)

**位置**: `src/controllers/`

- **websocket-controller.js**: WebSocket 业务逻辑控制器

**功能**:
- 协调各个服务模块
- 处理业务逻辑
- 管理 WebSocket 连接生命周期

### 4. 服务层 (Services)

**位置**: `src/services/`

- **websocket-client.js**: WebSocket 客户端实现

**核心功能**:
- 连接管理
- 断线重连（指数退避算法）
- 心跳保活（ping/pong）
- 空闲超时检测

### 5. 工具层 (Utils)

**位置**: `src/utils/`

- **message-formatter.js**: 消息格式化器
- **file-handler.js**: 文件处理器

**功能**:
- 消息格式转换（JSON、文本、二进制）
- 自定义格式化支持
- 文件读取和编码
- 文件信息提取

### 6. 配置层 (Config)

**位置**: `src/config/`

- **config-manager.js**: 配置管理器

**功能**:
- 配置存储和管理
- 配置验证
- 配置更新

### 7. 模型层 (Models)

**位置**: `src/models/`

- **message-model.js**: 消息数据模型

**功能**:
- 消息存储
- 消息查询
- 消息历史管理

## 数据流

### 连接建立流程

```
用户配置 → 保存配置 → 建立连接 → WebSocket 握手 → 连接成功
```

### 消息发送流程

```
用户输入 → 格式化消息 → 文件处理（如需要）→ WebSocket 发送 → 消息历史记录
```

### 消息接收流程

```
WebSocket 接收 → 消息解析 → 消息历史记录 → 前端显示
```

### 断线重连流程

```
连接断开 → 检测断开原因 → 指数退避延迟 → 尝试重连 → 连接成功/失败
```

## 关键技术点

### 1. 断线重连机制

- **指数退避算法**: 重连延迟逐渐增加，避免频繁重连
- **最大延迟限制**: 防止延迟过长
- **手动断开标记**: 区分主动断开和异常断开

### 2. 心跳保活机制

- **定时发送 ping**: 保持连接活跃
- **pong 响应检测**: 验证连接有效性
- **可配置间隔**: 支持自定义心跳间隔

### 3. 空闲超时检测

- **用户消息时间戳**: 记录最后用户操作时间
- **定时检查**: 定期检查是否超时
- **自动断开**: 超时后自动断开连接

### 4. 消息格式化

- **多格式支持**: JSON、文本、二进制
- **自定义格式化**: 支持函数式自定义
- **显示格式化**: 消息显示时的格式化处理

### 5. 文件处理

- **Base64 编码**: 文件转换为 Base64 传输
- **文件信息**: 提取文件元数据
- **大小限制**: 防止过大文件传输

## 错误处理

- **连接错误**: 自动重连机制
- **消息错误**: 返回错误信息给前端
- **文件错误**: 验证和友好提示
- **配置错误**: 配置验证机制

## 扩展性

- **模块化设计**: 各模块职责单一，易于扩展
- **事件驱动**: 使用 EventEmitter 实现松耦合
- **配置化**: 关键参数可配置
- **插件化**: 格式化器支持自定义函数
